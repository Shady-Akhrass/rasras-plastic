# خطة إصلاح مشاكل الصلاحيات في النظام

تم إعداد هذه الخطة بعد فحص الـ Backend (Spring) والـ Frontend (React) لتوحيد الصلاحيات ومنع الوصول غير المصرح به.

---

## 1. ملخص المشاكل

| # | النوع | الوصف | الخطورة |
|---|--------|--------|---------|
| 1 | واجهات بدون حماية | Controllers تعمل بأي مستخدم مصادق دون تحقق من دور/صلاحية | عالية |
| 2 | واجهات بحماية ناقصة | بعض الـ endpoints فقط محمية (مثلاً الاعتماد) | عالية |
| 3 | Frontend يستدعي واجهات مدير فقط | صفحات المستخدم العادي تستدعي GET /settings فتفشل (403) | متوسطة (تم جزئياً) |
| 4 | عدم تناسق المفاتيح | إعداد العملة في DB: DEFAULT_CURRENCY، والـ Public يعيد DefaultCurrency فقط | متوسطة |

---

## 2. مشاكل الـ Backend (تفصيل)

### 2.1 واجهات بدون أي @PreAuthorize (أي مستخدم مصادق يمكنه الوصول)

| Controller | المسار التقريبي | المخاطر |
|------------|-----------------|---------|
| **RoleController** | `/roles` | إنشاء/تعديل/حذف الأدوار — خطير جداً |
| **PermissionController** | `/permissions` | قراءة كل الصلاحيات — حساس |
| **RFQController** | `/procurement/rfq` | طلبات عروض الأسعار — يجب ربطها بقسم المشتريات |
| **SupplierQuotationController** | `/procurement/quotation` | عروض الموردين |
| **QuotationComparisonController** | `/procurement/comparison` | مقارنة العروض (القراءة/الحفظ تحتاج صلاحية) |
| **PurchaseReturnController** | شراء مرتجع | |
| **SupplierController** | `/suppliers` | الموردون |
| **SupplierInvoiceController** | فواتير الموردين | |
| **SalesOrderController** | `/sales/orders` | أوامر البيع |
| **SalesQuotationController** | عروض البيع | |
| **SalesInvoiceController** | فواتير البيع | |
| **DeliveryOrderController** | أوامر التوصيل | |
| **PaymentReceiptController** | إيصالات الدفع | |
| **CustomerRequestController** | طلبات العملاء | |
| **StockIssueNoteController** | إصدار مخزون | |
| **CustomerController** | `/crm/customers` | العملاء |
| **ApprovalLimitController** | `/approval-limits` | حدود الاعتماد — يجب أن تكون للمدير/الإدارة فقط |
| **StockTransferController** | نقل مخزون | |
| **StockMovementController** | حركة مخزون | |
| **StockBalanceController** | أرصدة مخزون | |
| **StockAdjustmentController** | تسوية مخزون | |
| **MaterialIssueController** | صرف مواد | |
| **QualityInspectionController** | فحص الجودة | |
| **QualityParameterController** | معايير الجودة | |
| **PriceListController** | قوائم الأسعار | |
| **ItemQualitySpecController** | مواصفات الجودة للأصناف | |

### 2.2 واجهات بحماية جزئية (بعض الـ endpoints فقط محمية)

| Controller | المشكلة |
|------------|---------|
| **ApprovalController** | `GET /approvals/pending` و `POST /approvals/{id}/action` **بدون** @PreAuthorize — أي مستخدم يمكنه استدعاء اعتماد/رفض (خطير). فقط `/approvals/audit` محمي. |
| **CompanyController** | `GET /company` بدون حماية (مقصود أحياناً للعرض العام)، `PUT` محمي — مقبول إذا كان GET للعرض فقط. |

### 2.3 تناسق إعدادات النظام (Public)

- في `SystemSettingService` الـ `PUBLIC_SETTING_KEYS` تحتوي على `"DefaultCurrency"` بينما في قاعدة البيانات المفتاح المخزن هو `"DEFAULT_CURRENCY"` (من initDefaultSettings).
- النتيجة: `GET /settings/public` لا يعيد العملة الافتراضية للمستخدمين العاديين، و`useSystemSettings` في الواجهة يعتمد على `getSetting('DefaultCurrency')` ولن يجد القيمة إذا اعتمدنا على Public فقط.

---

## 3. مشاكل الـ Frontend

### 3.1 Hook استخدام الإعدادات (useSystemSettings)

- يستدعي `systemService.getAllSettings()` وهو **مقصور على ADMIN / SYS_ADMIN**.
- أي صفحة تستخدم `useSystemSettings` (مقارنة العروض، الموردون، المالية، المخزون، إلخ) ستحصل على **403** للمستخدمين غير المدير، والـ hook يترك `settings = []` و`defaultCurrency = 'EGP'` كافتراضي.
- **النتيجة**: العملة والعروض تعمل بافتراضي لكن طلب الإعدادات يفشل بصمت (أخطاء في الـ console). يفضل جعل الـ hook يستخدم `getPublicSettings()` لقراءة الإعدادات العامة (مثل العملة وعدد العروض) لجميع المستخدمين المصادقين.

### 3.2 إخفاء القائمة حسب الصلاحيات

- القائمة الجانبية تعتمد على `permissionUtils` وربط المسارات بـ `SECTION_*`. إذا كان الـ Backend يسمح لصلاحية معينة والـ Frontend يخفي الرابط، أو العكس، يحدث تناقض. مراجعة أن كل مسار في القائمة يقابله نفس الصلاحيات في الـ API.

---

## 4. خطة الإصلاح (مراحل مقترحة)

### المرحلة 1 — حرجة (أولوية عالية)

1. **ApprovalController**
   - إضافة `@PreAuthorize("isAuthenticated()")` على الأقل لـ `GET /approvals/pending` مع التحقق داخل الخدمة أن `userId` يطابق المستخدم الحالي أو أن له صلاحية اعتماد.
   - إضافة `@PreAuthorize` لـ `POST /approvals/{id}/action` بحيث فقط من له صلاحية الاعتماد (مثلاً SECTION_MAIN أو أدوار GM, FM, ACC، إلخ) يمكنه تنفيذ الاعتماد/الرفض.

2. **RoleController**
   - حماية كل الـ endpoints بـ `@PreAuthorize("hasAnyRole('ADMIN', 'SYS_ADMIN', 'SYSTEM_ADMIN')")` (أو صلاحية مثل SECTION_SYSTEM إذا كانت معرّفة).

3. **PermissionController**
   - حماية `GET /permissions` بـ نفس منطق الإدارة (ADMIN/SYS_ADMIN) أو صلاحية إدارة الصلاحيات، لأن عرض الصلاحيات حساس.

4. **ApprovalLimitController**
   - حماية جميع الـ endpoints بـ صلاحية الإدارة أو SECTION_SYSTEM / أدوار المدير المالي والإدارة العليا.

### المرحلة 2 — حماية وحدات الأعمال

5. **المشتريات (Procurement)**
   - إضافة حماية على مستوى الـ class أو كل method لـ:
     - `RFQController`
     - `SupplierQuotationController`
     - `QuotationComparisonController`
     - `PurchaseReturnController`
     - `SupplierController`
     - `SupplierInvoiceController`
   - استخدام نفس منطق `PurchaseRequisitionController` و `PurchaseOrderController`:  
     `hasAnyRole('ADMIN', 'SYS_ADMIN', 'SYSTEM_ADMIN', 'GM') or hasAuthority('SECTION_OPERATIONS') or hasAuthority('SECTION_PROCUREMENT')` (أو SECTION_SALES حيث ينطبق).

6. **المبيعات (Sales)**
   - إضافة حماية لـ:
     - SalesOrderController, SalesQuotationController, SalesInvoiceController, DeliveryOrderController, PaymentReceiptController, CustomerRequestController, StockIssueNoteController
   - مثال: `hasAnyRole('ADMIN', 'SYS_ADMIN', 'SYSTEM_ADMIN', 'GM') or hasAuthority('SECTION_SALES') or hasAuthority('SECTION_OPERATIONS')`.

7. **المخزون (Inventory / Warehouse)**
   - حماية: StockTransferController, StockMovementController, StockBalanceController, StockAdjustmentController, MaterialIssueController, QualityInspectionController, QualityParameterController, PriceListController, ItemQualitySpecController
   - بمحاذاة ItemController / WarehouseController: أدوار + SECTION_WAREHOUSE / SECTION_OPERATIONS / INVENTORY_VIEW، إلخ.

8. **CRM**
   - حماية `CustomerController` بـ SECTION_CRM أو أدوار المبيعات/الإدارة.

### المرحلة 3 — إعدادات وعرض عام

9. **إعدادات النظام (Public)**
   - في `SystemSettingService`: إضافة `"DEFAULT_CURRENCY"` إلى `PUBLIC_SETTING_KEYS` (بجانب `RequireThreeQuotations` و`DefaultCurrency` إن لزم) حتى يعيد `GET /settings/public` العملة الافتراضية المخزنة في DB.
   - في الـ Frontend: تعديل `useSystemSettings` لاستخدام `getPublicSettings()` بدلاً من `getAllSettings()`، ودعم المفتاحين `DefaultCurrency` و `DEFAULT_CURRENCY` عند قراءة العملة الافتراضية حتى يعمل كل المستخدمين (مشترين، مالية، إلخ) بدون 403.

10. **مراجعة CompanyController**
    - إذا كان `GET /company` مطلوباً للمستخدمين غير المصادقين (مثلاً صفحة عامة) يبقى كما هو. إن كان للوحة التحكم فقط يمكن تقييده بـ `isAuthenticated()`.

### المرحلة 4 — توحيد وتوثيق

11. **توحيد الأدوار والصلاحيات**
    - مراجعة أن كل صلاحية `SECTION_*` و`*_VIEW`/`*_CREATE` المستخدمة في الـ Backend معرّفة في جدول الصلاحيات ومربوطة بالأدوار في لوحة الأدوار والصلاحيات.
    - توثيق في `doc/توثيق_الصلاحيات.md`: أي دور يصل لأي واجهة، وأي صفحة في الـ Frontend تتطلب أي صلاحية.

12. **اختبارات الصلاحيات**
    - اختبار تسجيل الدخول كـ (مشتري، محاسب، مدير مخزون، مدير نظام) والتحقق من:
      - نجاح/فشل استدعاءات الـ API المتوقعة.
      - إخفاء/إظهار عناصر القائمة والمسارات حسب الصلاحيات.

---

## 5. ملخص أولويات التنفيذ

| الأولوية | البند | الجهد التقريبي |
|----------|--------|-----------------|
| 1 | حماية ApprovalController (اعتماد + pending) | منخفض |
| 2 | حماية RoleController و PermissionController و ApprovalLimitController | منخفض |
| 3 | إصلاح useSystemSettings + PUBLIC_SETTING_KEYS (DEFAULT_CURRENCY) | منخفض |
| 4 | حماية كل Controllers المشتريات ثم المبيعات ثم المخزون ثم CRM | متوسط |
| 5 | توثيق واختبارات الصلاحيات | متوسط |

---

## 6. ملاحظات

- **تم بالفعل**: إضافة `GET /settings/public` واستخدامها في صفحة مقارنة العروض لقراءة `RequireThreeQuotations` حتى يعمل المستخدمون غير المديرين.
- **يفضل**: استخدام صلاحيات (Authorities) مثل `SECTION_PROCUREMENT` بدلاً من الاعتماد على الأدوار فقط، حتى تكون الصلاحيات قابلة للتخصيص من لوحة الأدوار والصلاحيات دون تغيير الكود.
- **CrossOrigin**: بعض الـ Controllers تحتوي على `@CrossOrigin(origins = "*")` — إن كان CORS مضبوطاً عالمياً في SecurityConfig فيكفي إزالته من الـ Controller لتجنب التكرار.

تم إعداد الخطة بتاريخ: 2025-02-19

---

## 7. تم التنفيذ (تنفيذ الخطة)

تم تنفيذ المراحل 1–3 وفق أفضل الممارسات:

### ما تم تنفيذه

1. **ثوابت الصلاحيات (Best practice – DRY)**  
   - إنشاء `shared/security/SecurityConstants.java` يجمع تعابير الصلاحيات: `SYSTEM_ADMIN_ONLY`, `APPROVAL_ACTION`, `AUTHENTICATED`, `PROCUREMENT_SECTION`, `SALES_SECTION`, `FINANCE_SECTION`, `WAREHOUSE_SECTION`, `CRM_SECTION`.

2. **المرحلة 1 – الحرجة**  
   - **ApprovalController**: `GET /pending` → `isAuthenticated()`؛ `GET /audit` و `POST /{id}/action` → صلاحية الاعتماد (APPROVAL_ACTION).  
   - **RoleController**: حماية على مستوى الـ class بـ SYSTEM_ADMIN_ONLY.  
   - **PermissionController**: حماية بـ SYSTEM_ADMIN_ONLY.  
   - **ApprovalLimitController**: حماية بـ SYSTEM_ADMIN_ONLY.

3. **المرحلة 2 – وحدات الأعمال**  
   - **المشتريات**: RFQ, SupplierQuotation, QuotationComparison, PurchaseReturn, Supplier, SupplierInvoice + توحيد PR, PO, GRN لاستخدام `SecurityConstants.PROCUREMENT_SECTION`.  
   - **المبيعات**: SalesOrder, SalesQuotation, SalesInvoice, DeliveryOrder, PaymentReceipt, CustomerRequest, StockIssueNote → SALES_SECTION.  
   - **المخزون**: StockTransfer, StockMovement, StockBalance, StockAdjustment, MaterialIssue, QualityInspection, QualityParameter, PriceList, ItemQualitySpec → WAREHOUSE_SECTION.  
   - **CRM**: CustomerController → CRM_SECTION.

4. **المرحلة 3 – الإعدادات والواجهة**  
   - **SystemSettingService**: إضافة `DEFAULT_CURRENCY` إلى `PUBLIC_SETTING_KEYS` ليعيد العملة من DB.  
   - **useSystemSettings**: استخدام `getPublicSettings()` بدلاً من `getAllSettings()`، ودعم المفتاحين `DefaultCurrency` و `DEFAULT_CURRENCY` للعملة الافتراضية.  
   - **SystemSettingController**: استخدام `SecurityConstants` للتوحيد.

### تنفيذ المرحلة 4 (توثيق واختبارات) — مكتمل

- **التوثيق:** تم توسيع `doc/توثيق_الصلاحيات.md` ليشمل:
  - مصفوفة واجهات الـ API والصلاحيات (الثوابت في SecurityConstants وربط المسارات بالحماية).
  - مصفوفة المسارات والصلاحيات في الواجهة (permissionUtils).
  - تهيئة DataSeeder (جدول الأدوار ↔ صلاحيات الأقسام) مع إضافة الصفوف الناقصة (FM/ACC، QC).
  - قائمة تحقق يدوية لاختبار الصلاحيات (مشتري، محاسب، أمين مخزن، مدير نظام) وخطوات تشغيل الاختبارات الآلية.
- **الاختبارات الآلية:** تم إضافة `PermissionSecurityIntegrationTests` (WebMvcTest) للتحقق من:
  - 401 لطلبات غير مصادقة على مسارات محمية.
  - 200/403 حسب الدور والصلاحية (مشتري يصل للمشتريات ولا يصل للأدوار؛ مدير نظام يصل لكل شيء؛ محاسب بدون مشتريات → 403 على /procurement/pr).
- **تشغيل الاختبارات:** من مجلد `web/backend`: `.\mvnw.cmd test -Dtest=PermissionSecurityIntegrationTests`.
