# توثيق الصلاحيات في نظام RasRas ERP

## نظرة عامة

يعتمد النظام على نموذج **صلاحيات ديناميكية** تُدار من لوحة التحكم دون تعديل الكود. مصدر الحقيقة الوحيد لظهور القوائم والوصول للمسارات هو جدول `rolepermissions` المرتبط بالأدوار.

---

## 1. هيكل البيانات

### الجداول ذات الصلة

| الجدول | الوصف |
|--------|--------|
| `roles` | الأدوار (مثل ADMIN، PM، SM، WHM) |
| `permissions` | تعريفات الصلاحيات (مثل SECTION_PROCUREMENT، SECTION_WAREHOUSE) |
| `rolepermissions` | ربط الأدوار بالصلاحيات (الجدول الوسيط) |
| `users` | المستخدمون، وكل مستخدم مرتبط بدور واحد |

### الكيانات (Backend)

- **Role**: الدور (مثل PM، SM، WHM)
- **Permission**: الصلاحية (مثلاً `SECTION_PROCUREMENT`)
- **RolePermission**: ربط الدور بالصلاحية مع حقل `IsAllowed`

---

## 2. صلاحيات الأقسام (SECTION_*)

صلاحيات الأقسام تحدد **ما يظهر في القائمة الجانبية** وما يمكن للمستخدم الوصول إليه من مسارات.

| كود الصلاحية | الوصف | المسارات المرتبطة |
|--------------|--------|-------------------|
| SECTION_MAIN | الرئيسية والاعتمادات | لوحة القيادة، الطلبات والاعتمادات |
| SECTION_USERS | المستخدمين | `/dashboard/users` |
| SECTION_EMPLOYEES | الموظفين | `/dashboard/employees` |
| SECTION_PROCUREMENT | المشتريات | `/dashboard/procurement/*` |
| SECTION_SALES | المبيعات | `/dashboard/sales/*` |
| SECTION_CRM | العملاء (CRM) | `/dashboard/crm/*` |
| SECTION_FINANCE | المالية والمحاسبة | `/dashboard/finance/*` |
| SECTION_WAREHOUSE | المخازن | `/dashboard/inventory/*` (عدا العمليات) |
| SECTION_OPERATIONS | العمليات | quality-parameters, price-lists, units, categories, items |
| SECTION_SYSTEM | إعدادات النظام | `/dashboard/settings/*` |

**ملاحظة:** المسارات `/dashboard` و `/dashboard/approvals` و `/dashboard/profile` متاحة لجميع من سجّل دخوله ولا تحتاج صلاحية قسم.

### صلاحيات كاملة (ADMIN و GM)

لا توجد أدوار ثابتة في الكود. الوصول لجميع الـ API يعتمد **فقط** على الصلاحيات المعيّنة من صفحة **الأدوار والصلاحيات** (جدول `rolepermissions`).

| الدور | في الـ Seed | الوصف |
|------|------------|--------|
| **ADMIN** | يُعطى كل صلاحيات الأقسام (SECTION_*) تلقائياً | مدير النظام — صلاحيات كاملة لأن الـ Seed يربطه بكل SECTION_* |
| **GM (المدير العام)** | يُعطى كل SECTION_* تلقائياً | رقابة واعتماد — نفس السبب |

**مهم:** الـ Backend لا يستخدم `hasAnyRole('ADMIN','GM')` لأي قسم. التعبيرات في `SecurityConstants` كلها من نوع `hasAuthority('SECTION_XXX')`. من تريد أن يكون له وصول لقسم معيّن (مثل المشتريات أو المبيعات) تُعيّن له الصلاحية من صفحة الصلاحيات فقط.

### ثوابت أكواد الأدوار (Frontend)

لتجنّب الاعتماد على Strings مبعثرة، استخدم الثوابت المركزية في `web/frontend/src/constants/roleCodes.ts`:

```typescript
import { ROLE_CODES } from '../constants/roleCodes';
// ROLE_CODES.FINANCE_MANAGER = "FM"
// ROLE_CODES.ACCOUNTANT = "ACC"
// ROLE_CODES.WAREHOUSE_KEEPER = "WHM"
// إلخ
```

---

## 3. تدفق الصلاحيات من الباكند إلى الواجهة

### 3.1 عند تسجيل الدخول

```
المستخدم يسجل الدخول
       ↓
AuthenticationManager يتحقق من الهوية
       ↓
UserDetailsService يحمّل المستخدم عبر findByUsernameWithPermissions
       ↓
UserPrincipal.create(user) يُنشئ الصلاحيات من role.rolePermissions
       ↓
صلاحيات الدور (التي تبدأ بـ SECTION_ وغيرها) تُضاف كـ GrantedAuthority
       ↓
AuthService.login يجمع الصلاحيات (باستثناء ROLE_*) ويضعها في LoginResponse.permissions
       ↓
الواجهة تحفظ user في localStorage (يشمل permissions)
```

### 3.2 تفاصيل تقنية

- **UserRepository**: استعلام `findByUsernameWithPermissions` يحمّل المستخدم مع دورهِ وصلاحيات الدور (`rolePermissions`).
- **UserPrincipal**: يحوّل `RolePermission` (حيث `isAllowed = true`) إلى `SimpleGrantedAuthority` بأكواد الصلاحيات.
- **AuthService**: يجمع من `userPrincipal.getAuthorities()` كل ما لا يبدأ بـ `ROLE_` ويرسله كقائمة `permissions` في استجابة تسجيل الدخول.

---

## 4. استخدام الصلاحيات في الواجهة (Frontend)

### 4.1 تخزين بيانات المستخدم

بعد تسجيل الدخول تُحفظ في `localStorage`:

```javascript
localStorage.setItem('user', JSON.stringify({
  userId, employeeId, username, roleCode, roleName,
  fullNameAr,
  permissions: ['SECTION_MAIN', 'SECTION_PROCUREMENT', ...]
}));
```

لا تعتمد على `localStorage` فقط — استخدم `refreshUserPermissions()` من `authService` لتحديث الصلاحيات من الخادم (راجع القسم 8).

### 4.2 القائمة الجانبية (Sidebar)

في `DashboardLayout.tsx`:

- كل عنصر قائمة له حقل `requiredPermission` اختياري (مثل `SECTION_PROCUREMENT`).
- إذا لم يكن للعنصر `requiredPermission` → يظهر للجميع.
- إذا كان له `requiredPermission` → يظهر فقط إن كان لدى المستخدم هذه الصلاحية في `user.permissions`.

```javascript
const filteredNavItems = navItems.filter(item => {
  if (!item.requiredPermission) return true;
  return userPermissions.includes(item.requiredPermission);
});
```

لا يوجد رجوع للأدوار: التصفية تعتمد على الصلاحيات فقط.

### 4.3 حماية المسارات

في `permissionUtils.ts`، الدالة `canAccessPath(path, userRole, userPermissions)`:

- تحدد الصلاحية المطلوبة للمسار عبر `getRequiredPermissionForPath`.
- إذا لم يحتج المسار صلاحية (مثل `/dashboard`، `/dashboard/approvals`) → يُسمح بالدخول.
- إذا احتاج صلاحية → يُسمح فقط إن كانت موجودة في `userPermissions`.

```javascript
export function canAccessPath(path, _userRole, userPermissions) {
  const required = getRequiredPermissionForPath(path);
  if (!required) return true;
  return userPermissions?.includes(required) ?? false;
}
```

`DashboardLayout` يستخدم `canAccessPath` عند تغيير المسار؛ إن لم يكن للمستخدم الصلاحية يُوجّه إلى `/dashboard`.

---

## 5. إدارة الصلاحيات من لوحة التحكم

### 5.1 صفحة الأدوار والصلاحيات

- المسار: `/dashboard/settings/roles`
- الصلاحية المطلوبة: `SECTION_SYSTEM`
- تُعرَض الأدوار مع إمكانية تعيين/إلغاء صلاحيات الأقسام لكل دور.

### 5.2 تعيين الصلاحيات للأدوار

- `RoleService.assignPermissions(roleId, permissionIds)` يستبدل صلاحيات الدور بقائمة الصلاحيات المحددة.
- التغييرات تنعكس عند **تسجيل الدخول التالي** للمستخدم، لأن الصلاحيات تُحمّل من الخادم في استجابة تسجيل الدخول.

---

## 6. التهيئة الافتراضية (DataSeeder)

عند التشغيل الأول يُنفّذ `DataSeeder`:

1. **seedSectionPermissions**: إنشاء صلاحيات الأقسام وتعيينها لـ ADMIN.
2. **seedDefaultRoleSectionPermissions**: تعيين صلاحيات الأقسام للأدوار الافتراضية:

| الدور | صلاحيات الأقسام |
|-------|-----------------|
| PM, BUYER | SECTION_MAIN, SECTION_PROCUREMENT |
| SM | SECTION_MAIN, SECTION_SALES, SECTION_CRM |
| WHM | SECTION_MAIN, SECTION_WAREHOUSE |
| GM | جميع الأقسام |
| FM, ACC | SECTION_MAIN, SECTION_FINANCE |
| QC | SECTION_MAIN, SECTION_OPERATIONS |

دور **WHM (أمين المخزن)** يُنشأ في `seedRoles` إن لم يكن موجوداً.

---

## 7. مصفوفة واجهات الـ API والصلاحيات (Backend)

جميع الـ Controllers محمية بـ `@PreAuthorize`. الثوابت المعتمدة في `SecurityConstants.java`:

| الثابت | الأدوار | الصلاحيات (Authorities) | الوصف |
|--------|---------|-------------------------|-------|
| SYSTEM_ADMIN_ONLY | ADMIN, SYS_ADMIN, SYSTEM_ADMIN | — | إعدادات النظام، الأدوار، الصلاحيات، حدود الاعتماد |
| AUTHENTICATED | أي مستخدم مصادق | — | قائمة الاعتمادات المعلقة، إعدادات عامة (GET /settings/public) |
| APPROVAL_ACTION | ADMIN, SYS_ADMIN, SYSTEM_ADMIN, GM, FM, ACC | SECTION_MAIN | سجل الاعتمادات، تنفيذ اعتماد/رفض |
| PROCUREMENT_SECTION | ADMIN, SYS_ADMIN, SYSTEM_ADMIN, GM | SECTION_OPERATIONS, SECTION_PROCUREMENT, SECTION_SALES | طلبات شراء، أوامر شراء، GRN، RFQ، عروض، مقارنة، مرتجع، موردون، فواتير موردين |
| SALES_SECTION | ADMIN, SYS_ADMIN, SYSTEM_ADMIN, GM | SECTION_SALES, SECTION_OPERATIONS | أوامر بيع، عروض بيع، فواتير، توصيل، إيصالات، طلبات عملاء، إصدار مخزون |
| FINANCE_SECTION | ADMIN, SYS_ADMIN, SYSTEM_ADMIN, GM, FM, ACC | SECTION_FINANCE | سندات الصرف، اعتماد مالي |
| WAREHOUSE_SECTION | ADMIN, MANAGER, SYS_ADMIN, SYSTEM_ADMIN, GM | INVENTORY_VIEW, SECTION_WAREHOUSE, SECTION_OPERATIONS, SECTION_PROCUREMENT | أصناف، مخازن، وحدات، تصنيفات، أرصدة، نقل، تسوية، صرف مواد، جودة، قوائم أسعار |
| CRM_SECTION | ADMIN, SYS_ADMIN, SYSTEM_ADMIN, GM | SECTION_CRM, SECTION_SALES | العملاء (CRM) |

### ربط المسار (Base path) بالحماية

| المسار (Base) | الثابت / الحماية |
|---------------|-------------------|
| GET/PUT /settings (عدا /public) | SYSTEM_ADMIN_ONLY |
| GET /settings/public | AUTHENTICATED |
| GET /approvals/pending | AUTHENTICATED |
| GET /approvals/audit, POST /approvals/{id}/action | APPROVAL_ACTION |
| /roles, /permissions, /approval-limits | SYSTEM_ADMIN_ONLY |
| /procurement/pr, /procurement/po, /procurement/rfq, /procurement/quotation, /procurement/comparison, /procurement/returns, /suppliers, /suppliers/invoices | PROCUREMENT_SECTION |
| /inventory/grn | PROCUREMENT_SECTION |
| /sales/* (orders, quotations, invoices, delivery-orders, receipts, customer-requests, issue-notes) | SALES_SECTION |
| /finance/payment-vouchers | FINANCE_SECTION |
| /inventory/items, /inventory/warehouses, /units, /inventory/categories, /inventory/stocks, /inventory/transfers, /stock-movements, /inventory/adjustments, /inventory/material-issues, /inventory/quality-inspection, /inventory/quality-parameters, /inventory/price-lists, /inventory/item-quality-specs | WAREHOUSE_SECTION |
| /crm/customers | CRM_SECTION |
| /hr/* | HR_VIEW أو أدوار ADMIN, MANAGER, SYS_ADMIN, SYSTEM_ADMIN |
| /employees/* (عدا /me, /list) | HR_VIEW أو نفس الأدوار |
| /users/* (عدا /roles للقراءة أحياناً) | USER_VIEW أو أدوار ADMIN, MANAGER, SYS_ADMIN, SYSTEM_ADMIN |
| /journal-entries/* | ACCOUNTING_VIEW أو نفس الأدوار |
| /settings/database/* | SYSTEM_ADMIN_ONLY (ADMIN, SYS_ADMIN) |

---

## 8. مصفوفة المسارات والصلاحيات (Frontend)

من `permissionUtils.ts` — المسار يحدد الصلاحية المطلوبة:

| نمط المسار | الصلاحية المطلوبة |
|------------|-------------------|
| /dashboard، /dashboard/approvals، /dashboard/profile | لا شيء (عام) |
| /dashboard/users | SECTION_USERS |
| /dashboard/employees، /dashboard/hr | SECTION_EMPLOYEES |
| /dashboard/settings | SECTION_SYSTEM |
| /dashboard/procurement (مع grn أو waiting-imports) | SECTION_OPERATIONS |
| /dashboard/procurement | SECTION_PROCUREMENT |
| /dashboard/audit | SECTION_MAIN |
| /dashboard/sales | SECTION_SALES |
| /dashboard/crm | SECTION_CRM |
| /dashboard/finance | SECTION_FINANCE |
| /dashboard/inventory (quality-inspection، quality-parameters، price-lists، units، categories، items) | SECTION_OPERATIONS |
| /dashboard/inventory | SECTION_WAREHOUSE |

يجب أن تتطابق هذه الصلاحيات مع ما يعيده الـ Backend في `permissions` للمستخدم حتى تظهر القائمة والمسارات بشكل صحيح.

---

## 9. اختبار الصلاحيات (Checklist يدوي)

يُنصح بتنفيذ الاختبارات التالية بعد أي تعديل على الأدوار أو الصلاحيات.

### 9.1 مستخدم بدور مشتري (BUYER)

- [ ] تسجيل الدخول بنجاح.
- [ ] يظهر في القائمة: الرئيسية، الاعتمادات، المشتريات (طلبات شراء، RFQ، عروض، مقارنة، أوامر شراء، GRN، مرتجع، موردون، إلخ).
- [ ] لا يظهر: المبيعات، المالية، المخازن (إن لم تُعطَ له)، الإعدادات، المستخدمون، الموظفون.
- [ ] GET /procurement/pr → 200.
- [ ] GET /settings/public → 200 (مثلاً لصفحة مقارنة العروض).
- [ ] GET /roles أو GET /permissions → 403.
- [ ] GET /settings (كامل) → 403.
- [ ] GET /dashboard/sales/orders (من الواجهة) → إعادة توجيه أو منع حسب canAccessPath.

### 9.2 مستخدم بدور محاسب (ACC)

- [ ] يظهر: الرئيسية، الاعتمادات، المالية.
- [ ] GET /finance/payment-vouchers → 200.
- [ ] GET /approvals/audit أو POST /approvals/{id}/action (حسب سير العمل) → 200 إن كان المعتمد.
- [ ] GET /procurement/pr → 403 (إن لم تُعطَ SECTION_PROCUREMENT).

### 9.3 مستخدم بدور أمين مخزن (WHM)

- [ ] يظهر: الرئيسية، الاعتمادات، المخازن (أصناف، مخازن، أرصدة، نقل، إلخ).
- [ ] GET /inventory/items، GET /inventory/warehouses → 200.
- [ ] GET /procurement/pr → 403 (إن لم تُعطَ SECTION_PROCUREMENT).

### 9.4 مستخدم بدور مدير نظام (ADMIN / SYS_ADMIN)

- [ ] يظهر كل الأقسام بما فيها الإعدادات.
- [ ] GET /settings، GET /roles، GET /permissions، GET /approval-limits → 200.
- [ ] GET /settings/database/* → 200.

### 9.5 اختبارات إضافية

- [ ] تحديث الصلاحيات من لوحة الأدوار ثم استدعاء `refreshUserPermissions()` أو إعادة تسجيل الدخول — تتغير القائمة والوصول وفق الصلاحيات الجديدة.
- [ ] مسار محمي (مثل /dashboard/settings) يُكتَب يدوياً في المتصفح لمستخدم بدون SECTION_SYSTEM — يُعاد توجيهه إلى /dashboard أو يُرفض.

### 9.6 تشغيل اختبارات الصلاحيات (Backend)

يوجد اختبار تكامل آلي في المشروع يتحقق من تطبيق قواعد الصلاحيات على واجهات الـ API:

- **الملف:** `web/backend/src/test/java/com/rasras/erp/security/PermissionSecurityIntegrationTests.java`
- **التشغيل:** من مجلد `web/backend` نفّذ:
  ```bash
  .\mvnw.cmd test -Dtest=PermissionSecurityIntegrationTests
  ```
- **ما يختبره:**
  - غير مصادق: GET /procurement/pr، /settings/public، /roles → 401
  - مشتري (BUYER) + SECTION_PROCUREMENT: GET /procurement/pr و /settings/public → 200؛ GET /roles و /settings → 403
  - مدير نظام (ADMIN): GET /roles، /settings، /procurement/pr → 200
  - محاسب (ACC) + SECTION_FINANCE فقط: GET /procurement/pr → 403؛ GET /settings/public → 200

---

## 10. ملخص التدفق

```
┌─────────────────────────────────────────────────────────────────┐
│  لوحة التحكم: الأدوار والصلاحيات                                 │
│  المدير يختار الدور ويعيّن له SECTION_* المناسبة                  │
└──────────────────────────┬──────────────────────────────────────┘
                           │ rolepermissions
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  تسجيل الدخول                                                    │
│  UserPrincipal يقرأ role.rolePermissions                         │
│  AuthService يرسل permissions في LoginResponse                   │
└──────────────────────────┬──────────────────────────────────────┘
                           │ user.permissions
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  الواجهة الأمامية                                                │
│  • السايد بار: يظهر العنصر إن وُجدت requiredPermission في permissions │
│  • المسارات: canAccessPath يتحقق من وجود الصلاحية المطلوبة       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 11. تحديث الصلاحيات دون إعادة تسجيل الدخول

لتجنّب الاعتماد على `localStorage` فقط (لأن الصلاحيات قد تتغيّر من لوحة الأدوار دون علم المستخدم الحالي):

- **API**: `GET /auth/me` يُرجع المستخدم الحالي مع `permissions` من الخادم.
- **الواجهة**: الدالة `refreshUserPermissions()` في `authService.ts` تستدعي `/auth/me` وتحدّث `localStorage.user`.
- **متى تُستدعى**: `DashboardLayout` يستدعيها عند التحميل الأوّل للوحة التحكم، فتُحدَّث الصلاحيات من الخادم تلقائياً.

```typescript
// استدعاء يدوي عند الحاجة (مثلاً بعد تغيير الدور من لوحة الأدوار)
import { refreshUserPermissions } from '../../services/authService';
await refreshUserPermissions();
```

---

## 12. ملاحظات مهمة

1. **تحديث الصلاحيات**: يُحدَّث تلقائياً عند فتح لوحة التحكم عبر `refreshUserPermissions`. التغييرات الفورية (مثلاً بعد تعديل الأدوار) ستُنعكس عند تنقّل المستخدم أو إعادة تحميل الصفحة.
2. **حماية الباكند**: التحقق في الواجهة يمنع الوصول للمسارات والقوائم. ينبغي أن تكون واجهات الباكند محمية أيضاً حسب الدور والصلاحيات.
3. **مصدر واحد للحقيقة**: ظهور الأقسام والوصول للمسارات يعتمد على صلاحيات الأدوار في قاعدة البيانات فقط، دون قوائم أدوار ثابتة في الكود.
4. **Action-level permissions** (مثل "إنشاء"، "تعديل"، "حذف") ستُضاف كمرحلة قادمة — حالياً الاعتماد على صلاحيات الأقسام.

---

## 13. ترتيب الأدوار والاعتماد

**من يرى طلبات الاعتماد؟** عرض طلبات الاعتماد (صفحة الطلبات والاعتمادات) يعتمد على **مطابقة دور المستخدم** مع **دور المعتمد** في الخطوة الحالية لسير العمل، وليس على صلاحية قسم أو صلاحية "اعتماد" فقط. أي أن المستخدم يرى فقط الطلبات التي تكون خطوتها الحالية معتمدة على **دوره** (مقارنة `RoleId` في جدول `approvalworkflowsteps`). استثناء: دور **ADMIN** يرى جميع طلبات الاعتماد.

### جدول: نوع المستند / سير العمل → الدور المعتمد

| نوع المستند | كود السير | الأدوار المعتمدة (بالترتيب أو حسب المبلغ) |
|-------------|-----------|------------------------------------------|
| طلب شراء (PR) | PR_APPROVAL | مدير المشتريات (**PM**) |
| أمر شراء (PO) | PO_APPROVAL | مدير المشتريات (**PM**) → المدير المالي (**FM**) → المدير العام (**GM**) حسب حدود المبلغ |
| إذن إضافة (GRN) | GRN_APPROVAL | مراقب الجودة (**QC**) ثم مدير المشتريات (**PM**) |
| مورد | SUPPLIER_APPROVAL | المدير العام (**GM**) |
| مرتجع مشتريات | (حسب السير) | (راجع DataSeeder / approvalworkflowsteps) |
| مقارنة عروض | (حسب السير) | (راجع DataSeeder) |
| سند صرف | PAYMENT_APPROVAL | محاسب (**ACC**) → المدير المالي (**FM**) → المدير العام (**GM**) حسب المبلغ |

**ملاحظة:** لاعتماد طلبات الشراء (PR) يجب أن يكون المستخدم معيّناً بدور **PM** (نفس السجل في جدول `roles` الذي يُستخدم في `approvalworkflowsteps`). إذا تم إنشاء دور آخر باسم "مدير المشتريات" لكن بكود مختلف (مثل P-M)، فلن يظهر له طلبات الاعتماد ما لم يُربط ذلك الدور في سير العمل.
